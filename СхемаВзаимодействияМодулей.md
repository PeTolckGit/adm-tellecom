Конечно! Вот схема взаимодействия модулей для компании-провайдера:

## 🏗️ **Общая архитектурная схема**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Клиентские приложения                            │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌────────────────┐                 │
│  │   Web LK    │  │ Mobile App   │  │   Admin Panel  │                 │
│  │  (Vue 3)    │  │ (React Native)│  │    (Vue 3)    │                 │
│  └──────┬──────┘  └──────┬───────┘  └───────┬────────┘                 │
│         │                 │                  │                          │
│  HTTPS/WebSocket         HTTPS              HTTPS                       │
└─────────┼─────────────────┼──────────────────┼──────────────────────────┘
          │                 │                  │
          ▼                 ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    API Gateway (BFF - Backend For Frontend)             │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  • Аутентификация/Авторизация                                    │  │
│  │  • Rate Limiting & CORS                                          │  │
│  │  • Request Aggregation                                           │  │
│  │  • Response Transformation                                       │  │
│  │  • GraphQL / REST API                                            │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
          │                 │                  │
          └─────────┬───────┴──────────────────┘
                    │
┌───────────────────┼─────────────────────────────────────────────────────┐
│         Internal Communication (HTTP/gRPC + Event-Driven)              │
├───────────────────┼─────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐         │
│  │ Auth Service │◄────►│Billing Service│◄────►│Customer Service│        │
│  └──────────────┘      └──────────────┘      └──────────────┘         │
│         ▲                     ▲                     ▲                  │
│         │                     │                     │                  │
│  ┌──────┴─────┐       ┌──────┴─────┐       ┌──────┴─────┐            │
│  │  Redis     │       │ PostgreSQL │       │   RabbitMQ │            │
│  │ (Session)  │       │   (Main)   │       │   (Events) │            │
│  └────────────┘       └────────────┘       └────────────┘            │
│                                                                         │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐         │
│  │Notification  │◄────►│ Support      │◄────►│ Monitoring   │         │
│  │ Service      │      │ Service      │      │ Service      │         │
│  └──────────────┘      └──────────────┘      └──────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 **Детальная схема взаимодействия**

### **1. Авторизация пользователя**
```
┌─────────┐    1. POST /auth/login    ┌─────────────┐
│  Client │ ─────────────────────────►│ API Gateway │
└─────────┘                           └──────┬──────┘
                                             │ 2. Проверка CORS, Rate Limit
                                             │ 3. Прокси в Auth Service
                                             ▼
                                    ┌─────────────────┐
                                    │   Auth Service  │
                                    └─────────┬───────┘
                                              │ 4. Проверка учетных данных
                                              │ 5. Генерация JWT + Refresh Token
                                              │ 6. Сохранение сессии в Redis
┌─────────┐    7. JWT + User Data   ┌─────────▼──────┐
│  Client │ ◄───────────────────────│  API Gateway  │
└─────────┘                           └──────────────┘
```

### **2. Просмотр счета в ЛК**
```
┌─────────┐    1. GET /billing/invoices    ┌─────────────┐
│ Web LK  │ ──────────────────────────────►│ API Gateway │
└─────────┘                                └──────┬──────┘
                                                  │ 2. Проверка JWT
                                                  │ 3. Извлечение user_id из токена
                                                  │ 4. Параллельные запросы:
                                                  │    a) Billing Service → счета
                                                  │    b) Customer Service → профиль
                                                  ▼
                    ┌─────────────────────────────────────────────┐
                    │          Aggregation & Transformation       │
                    └─────────────────────────────────────────────┘
┌─────────┐    5. Unified Response     ┌─────────▼──────────────┐
│ Web LK  │ ◄──────────────────────────│     API Gateway       │
└─────────┘                            └────────────────────────┘
```

### **3. Оплата счета**
```
┌─────────┐    1. POST /billing/pay    ┌─────────────┐
│  Client │ ──────────────────────────►│ API Gateway │
└─────────┘                            └──────┬──────┘
                                              │ 2. Валидация, проверка прав
                                              │ 3. Запрос в Billing Service
                                              ▼
                                    ┌─────────────────┐
                                    │ Billing Service │
                                    └─────────┬───────┘
                                              │ 4. Проверка баланса
                                              │ 5. Создание платежа
                                              │ 6. Событие "payment.created"
                                              ▼
                                    ┌─────────────────┐
                                    │   RabbitMQ      │
                                    └─────────┬───────┘
                            ┌─────────────────┼─────────────────┐
                            ▼                 ▼                 ▼
                    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
                    │ Notification│  │   Analytics │  │   Support   │
                    │   Service   │  │   Service   │  │   Service   │
                    └─────────────┘  └─────────────┘  └─────────────┘
                            │                 │                 │
                            │ 7. Push/SMS     │ 7. Обновление   │ 7. Обновление
                            │  Уведомление    │   статистики    │   тикета
```

### **4. Создание тикета в техподдержку**
```
┌─────────┐    1. POST /support/tickets    ┌─────────────┐
│  Client │ ──────────────────────────────►│ API Gateway │
└─────────┘                                └──────┬──────┘
                                                  │ 2. Проверка JWT
                                                  │ 3. Запрос в Support Service
                                                  ▼
                                    ┌──────────────────┐
                                    │  Support Service │
                                    └─────────┬────────┘
                                              │ 4. Создание тикета
                                              │ 5. Определение приоритета
                                              │ 6. Назначение оператору
                                              │ 7. Событие "ticket.created"
                                              ▼
                                    ┌──────────────────┐
                                    │   RabbitMQ/Kafka │
                                    └─────────┬────────┘
                            ┌─────────────────┼─────────────────┐
                            ▼                 ▼                 ▼
                    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
                    │ Notification│  │   CRM       │  │  Monitoring │
                    │   Service   │  │   Service   │  │   Service   │
                    └─────────────┘  └─────────────┘  └─────────────┘
```

## 📊 **Схема базы данных (основные связи)**

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│     users       │      │   customers     │      │    contracts    │
├─────────────────┤      ├─────────────────┤      ├─────────────────┤
│ • id (PK)       │1:1   │ • id (PK)       │1:M   │ • id (PK)       │
│ • email         │─────►│ • user_id (FK)  │◄─────│ • customer_id   │
│ • role          │      │ • contract_num  │      │ • tariff_id     │
│ • is_active     │      │ • balance       │      │ • address       │
└─────────────────┘      └─────────────────┘      └────────┬────────┘
         │                                                  │
         │1:M                                               │1:M
         ▼                                                  ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│    sessions     │      │    invoices     │      │  subscriptions  │
├─────────────────┤      ├─────────────────┤      ├─────────────────┤
│ • id (PK)       │      │ • id (PK)       │      │ • id (PK)       │
│ • user_id (FK)  │      │ • customer_id   │      │ • customer_id   │
│ • device_info   │      │ • amount        │      │ • tariff_id     │
│ • expires_at    │      │ • status        │      │ • status        │
└─────────────────┘      └────────┬────────┘      └─────────────────┘
                                   │
                                   │1:M
                                   ▼
                          ┌─────────────────┐      ┌─────────────────┐
                          │    payments     │      │   transactions  │
                          ├─────────────────┤      ├─────────────────┤
                          │ • id (PK)       │1:M   │ • id (PK)       │
                          │ • invoice_id    │─────►│ • payment_id    │
                          │ • amount        │      │ • type          │
                          │ • method        │      │ • amount        │
                          └─────────────────┘      └─────────────────┘
```

## 🔄 **Event Flow: Ежемесячная генерация счетов**

```
┌─────────────────┐
│  Billing Service│
│  (Cron Job)     │
└────────┬────────┘
         │ 1. Запуск по расписанию (1-е число месяца)
         ▼
┌─────────────────┐
│  Invoice        │
│  Generator      │
└────────┬────────┘
         │ 2. Получение активных подписок
         ▼
┌─────────────────┐
│  Subscription   │
│  Service        │
└────────┬────────┘
         │ 3. Для каждой подписки:
         │    - Рассчитать сумму
         │    - Создать счет
         ▼
┌─────────────────┐
│  Database       │
│  (invoices)     │
└────────┬────────┘
         │ 4. Публикация события
         ▼
┌─────────────────┐
│   RabbitMQ      │
│   (Events)      │
└────────┬────────┘
    ┌────┴────┐
    ▼         ▼
┌─────────┐ ┌─────────┐
│Notification││Analytics│
│ Service   ││ Service │
└─────────┘ └─────────┘
    │            │
    ▼            ▼
Email/SMS    Статистика
Уведомление  и отчеты
```

## 🛡️ **Security Flow: Защищенный доступ**

```
┌─────────┐          ┌─────────────┐          ┌──────────────┐
│ Client  │          │API Gateway  │          │Auth Service  │
└─────────┘          └─────────────┘          └──────────────┘
     │                      │                        │
     │ 1. Login Request     │                        │
     │─────────────────────►│                        │
     │                      │ 2. Forward to Auth     │
     │                      │───────────────────────►│
     │                      │                        │
     │                      │                        │ 3. Validate credentials
     │                      │                        │ 4. Generate JWT
     │                      │                        │ 5. Store session in Redis
     │                      │                        │
     │                      │ 6. Return JWT + User   │
     │                      │◄───────────────────────│
     │ 7. JWT + User Data   │                        │
     │◄─────────────────────│                        │
     │                      │                        │
     │ 8. Request with JWT  │                        │
     │─────────────────────►│                        │
     │                      │                        │
     │                      │ 9. Verify JWT          │
     │                      │    (stateless)         │
     │                      │ OR                     │
     │                      │ 10. Check Redis session│
     │                      │───────────────────────►│
     │                      │                        │
     │                      │ 11. Session valid      │
     │                      │◄───────────────────────│
     │                      │                        │
     │                      │ 12. Check RBAC         │
     │                      │───────────────────────►│
     │                      │                        │
     │                      │ 13. Permission granted │
     │                      │◄───────────────────────│
     │                      │                        │
     │                      │ 14. Forward to         │
     │                      │    Service             │
```

## 📱 **Mobile App Flow: Push Notifications**

```
┌─────────────┐    ┌─────────────┐    ┌──────────────┐    ┌──────────────┐
│ Mobile App  │    │API Gateway  │    │Notification  │    │Firebase/APNs │
└─────────────┘    └─────────────┘    │ Service      │    └──────────────┘
       │                  │            └──────────────┘           │
       │ 1. Register      │                  │                    │
       │    FCM/APNs token│                  │                    │
       │─────────────────►│                  │                    │
       │                  │ 2. Store token   │                    │
       │                  │─────────────────►│                    │
       │                  │                  │                    │
       │                  │                  │ 3. Event received  │
       │                  │                  │◄───────────────────│
       │                  │                  │    (payment, etc.) │
       │                  │                  │                    │
       │                  │                  │ 4. Prepare message │
       │                  │                  │    for user        │
       │                  │                  │                    │
       │                  │                  │ 5. Send to FCM/APNs│
       │                  │                  │───────────────────►│
       │                  │                  │                    │
       │ 6. Push received │                  │                    │
       │◄─────────────────────────────────────────────────────────│
```

## 🚨 **Monitoring & Alerting Flow**

```
┌─────────────┐    ┌─────────────┐    ┌──────────────┐    ┌──────────────┐
│  Services   │    │ Prometheus  │    │   Grafana    │    │ Alertmanager │
└─────────────┘    └─────────────┘    └──────────────┘    └──────────────┘
       │                  │                  │                    │
       │ 1. Metrics       │                  │                    │
       │    (HTTP, DB,    │                  │                    │
       │     Business)    │                  │                    │
       │─────────────────►│                  │                    │
       │                  │                  │                    │
       │                  │ 2. Scrape & Store│                    │
       │                  │─────────────────►│                    │
       │                  │                  │                    │
       │                  │                  │ 3. Visualize       │
       │                  │                  │    (Dashboards)    │
       │                  │                  │                    │
       │                  │ 4. Alert Rule    │                    │
       │                  │    triggered     │                    │
       │                  │───────────────────────────────────────►│
       │                  │                  │                    │
       │                  │                  │                    │ 5. Route Alert
       │                  │                  │                    │    (Email, SMS,
       │                  │                  │                    │     Slack, etc.)
```

Нужна более детальная схема для конкретного сценария или модуля?
